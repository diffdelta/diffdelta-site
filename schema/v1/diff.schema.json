{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://diffdelta.io/schema/v1/diff.schema.json",
  "title": "DiffDelta Diff Feed (v1) - Phase 1: Substrate Lockdown",
  "oneOf": [
    {
      "title": "Global Feed",
      "type": "object",
      "additionalProperties": false,
      "required": [
        "batch_narrative",
        "schema_version",
        "generated_at",
        "cursor",
        "prev_cursor",
        "changed",
        "ttl_sec",
        "sources_included",
        "sources",
        "buckets"
      ],
      "properties": {
        "batch_narrative": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 500,
          "description": "Human-readable summary of batch changes (max 30 words per SPEC.md)"
        },
        "schema_version": { "type": "string", "pattern": "^1\\.[0-9]+\\.[0-9]+$", "description": "Schema version. Breaking changes increment minor version (e.g., 1.0.0 -> 1.1.0)" },
        "generated_at": { "type": "string", "format": "date-time" },

        "cursor": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 200,
          "description": "Hash-based deterministic cursor (format: sha256:<64-char-hex>)"
        },
        "prev_cursor": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 200,
          "description": "Previous hash-based cursor (format: sha256:<64-char-hex>)"
        },
        "hash": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "SHA-256 hash of items/content only (deterministic sorting before hashing). Format: sha256:<64-char-hex>"
        },
        "prev_hash": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Previous hash value from previous latest.json. Format: sha256:<64-char-hex>"
        },
        "changed": { 
          "type": "boolean",
          "description": "True if any source changed. If false, cursor MUST equal prev_cursor."
        },
        "ttl_sec": { "type": "integer", "minimum": 15, "maximum": 3600 },
        "integrity_reset": {
          "type": "boolean",
          "description": "True if chain integrity was broken/reset (missing or corrupted previous latest.json)"
        },
        "integrity_risk": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Risk score (0.0-1.0) indicating integrity concerns. 0.2 if integrity_reset is true, 0.0 otherwise"
        },

        "sources_included": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" }
        },

        "sources": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/sourceStatus" }
        },

        "buckets": {
          "type": "object",
          "additionalProperties": false,
          "required": ["new", "updated", "removed", "flagged"],
          "properties": {
            "new": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "updated": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "removed": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "flagged": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } }
          }
        }
      }
    },
    {
      "title": "Per-Source Feed",
      "type": "object",
      "additionalProperties": false,
      "required": [
        "batch_narrative",
        "schema_version",
        "generated_at",
        "cursor",
        "prev_cursor",
        "changed",
        "ttl_sec",
        "sources_included",
        "sources",
        "buckets",
        "source_id",
        "status"
      ],
      "properties": {
        "batch_narrative": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 500,
          "description": "Human-readable summary of batch changes (max 30 words per SPEC.md)"
        },
        "schema_version": { "type": "string", "pattern": "^1\\.[0-9]+\\.[0-9]+$", "description": "Schema version. Breaking changes increment minor version (e.g., 1.0.0 -> 1.1.0)" },
        "generated_at": { "type": "string", "format": "date-time" },

        "cursor": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 200,
          "description": "Hash-based deterministic cursor (format: sha256:<64-char-hex>)"
        },
        "prev_cursor": { 
          "type": "string", 
          "minLength": 1,
          "maxLength": 200,
          "description": "Previous hash-based cursor (format: sha256:<64-char-hex>)"
        },
        "hash": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "SHA-256 hash of items/content only (deterministic sorting before hashing). Format: sha256:<64-char-hex>"
        },
        "prev_hash": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Previous hash value from previous latest.json. Format: sha256:<64-char-hex>"
        },
        "changed": { 
          "type": "boolean",
          "description": "True if any source changed. If false, cursor MUST equal prev_cursor."
        },
        "ttl_sec": { "type": "integer", "minimum": 15, "maximum": 3600 },
        "integrity_reset": {
          "type": "boolean",
          "description": "True if chain integrity was broken/reset (missing or corrupted previous latest.json)"
        },
        "integrity_risk": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Risk score (0.0-1.0) indicating integrity concerns. 0.2 if integrity_reset is true, 0.0 otherwise"
        },

        "sources_included": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" }
        },

        "sources": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/sourceStatus" }
        },

        "buckets": {
          "type": "object",
          "additionalProperties": false,
          "required": ["new", "updated", "removed", "flagged"],
          "properties": {
            "new": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "updated": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "removed": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
            "flagged": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } }
          }
        },
        
        "source_id": {
          "type": "string",
          "pattern": "^[a-z0-9_\\-]{2,32}$",
          "description": "Source identifier (required in per-source feeds)"
        },
        
        "status": {
          "type": "string",
          "enum": ["ok", "error", "disabled"],
          "description": "Source status (required in per-source feeds)"
        }
      }
    }
  ],

  "$defs": {
    "sourceStatus": {
      "type": "object",
      "additionalProperties": false,
      "required": ["changed", "cursor", "prev_cursor", "ttl_sec", "status"],
      "properties": {
        "changed": { "type": "boolean" },
        "cursor": { "type": "string", "minLength": 1, "maxLength": 200 },
        "prev_cursor": { "type": "string", "minLength": 1, "maxLength": 200 },
        "ttl_sec": { "type": "integer", "minimum": 15, "maximum": 3600 },
        "status": {
          "type": "string",
          "enum": ["ok", "error", "disabled"]
        },
        "error": {
          "type": "string",
          "description": "Error message if status is 'error'"
        }
      }
    },

    "deltaItem": {
      "type": "object",
      "additionalProperties": true,
      "required": ["source", "id", "url", "published_at", "updated_at", "headline", "content", "risk", "provenance"],
      "properties": {
        "source": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" },
        "id": { "type": "string", "minLength": 1, "maxLength": 200 },
        "url": { "type": "string", "format": "uri" },

        "title": { "type": "string", "maxLength": 200 },
        "published_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },

        "signals": {
          "type": "array",
          "maxItems": 10,
          "uniqueItems": true,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" }
        },

        "action_items": {
          "type": "array",
          "maxItems": 10,
          "items": { "$ref": "#/$defs/actionItem" }
        },

        "headline": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2000,
          "description": "Deterministic title-like field derived from source (RSS title, etc.). Not an LLM summary."
        },
        
        "summary": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2000,
          "description": "Optional LLM-generated summary (pre-chewed content). Can be absent or 'pending' if not yet generated."
        },
        
        "content": {
          "type": "object",
          "additionalProperties": false,
          "required": ["lang"],
          "properties": {
            "excerpt_text": {
              "type": "string",
              "maxLength": 500,
              "description": "Plain text excerpt extracted from HTML for agents/diffing"
            },
            "lang": {
              "type": "string",
              "pattern": "^[a-z]{2}$",
              "description": "ISO 639-1 language code (e.g., 'en', 'es')"
            }
          }
        },

        "risk": { "$ref": "#/$defs/risk" },
        "provenance": { "$ref": "#/$defs/provenance" },
        
        "source_payload": {
          "type": "object",
          "additionalProperties": true,
          "description": "Opaque raw upstream data from the source, preserved for debugging and traceability. HTML content is consolidated into 'html' field (removes duplicate description/summary)."
        }
      }
    },

    "actionItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "text"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["investigate", "workaround", "fix_posted", "upgrade", "ignore", "monitor", "block"]
        },
        "text": { "type": "string", "minLength": 1, "maxLength": 280 },
        "url": { "type": "string", "format": "uri" }
      }
    },

    "risk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["score", "reasons"],
      "properties": {
        "score": { "type": "number", "minimum": 0, "maximum": 1 },
        "reasons": {
          "type": "array",
          "maxItems": 10,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,64}$" }
        }
      }
    },

    "provenance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["fetched_at", "evidence_urls", "content_hash"],
      "properties": {
        "fetched_at": { "type": "string", "format": "date-time" },
        "evidence_urls": {
          "type": "array",
          "minItems": 1,
          "maxItems": 20,
          "items": { "type": "string", "format": "uri" }
        },
        "content_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 hash of canonical content for integrity verification (prefixed with 'sha256:')"
        }
      }
    }
  }
}
