{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://diffdelta.io/schema/v1/diff.schema.json",
  "title": "DiffDelta Diff Feed (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "generated_at",
    "cursor",
    "prev_cursor",
    "changed",
    "ttl_sec",
    "sources_included",
    "new",
    "updated",
    "resolved",
    "flagged",
    "meta"
  ],
  "properties": {
    "schema_version": { "type": "string", "pattern": "^1\\.[0-9]+\\.[0-9]+$" },
    "generated_at": { "type": "string", "format": "date-time" },

    "cursor": { "type": "string", "minLength": 1, "maxLength": 200 },
    "prev_cursor": { "type": "string", "minLength": 1, "maxLength": 200 },
    "changed": { "type": "boolean" },
    "ttl_sec": { "type": "integer", "minimum": 15, "maximum": 3600 },

    "sources_included": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" }
    },

    "new": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
    "updated": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
    "resolved": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },
    "flagged": { "type": "array", "items": { "$ref": "#/$defs/deltaItem" } },

    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["target_max_payload_kb", "generator_version"],
      "properties": {
        "target_max_payload_kb": { "type": "integer", "minimum": 10, "maximum": 2000 },
        "generator_version": { "type": "string", "minLength": 1, "maxLength": 64 }
      }
    }
  },

  "$defs": {
    "deltaItem": {
      "type": "object",
      "additionalProperties": true,
      "required": ["source", "id", "url", "published_at", "updated_at", "change_reason", "summary", "risk", "provenance"],
      "properties": {
        "source": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" },
        "id": { "type": "string", "minLength": 1, "maxLength": 200 },
        "url": { "type": "string", "format": "uri" },

        "title": { "type": "string", "maxLength": 200 },
        "published_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },

        "change_reason": {
          "type": "string",
          "enum": ["new_item", "content_changed", "status_changed", "risk_detected", "manual_override", "backfill"]
        },

        "signals": {
          "type": "array",
          "maxItems": 10,
          "uniqueItems": true,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,32}$" }
        },

        "action_items": {
          "type": "array",
          "maxItems": 10,
          "items": { "$ref": "#/$defs/actionItem" }
        },

        "summary": { "type": "string", "minLength": 1, "maxLength": 2000 },

        "risk": { "$ref": "#/$defs/risk" },
        "provenance": { "$ref": "#/$defs/provenance" },

        "source_payload": { "type": "object" }
      }
    },

    "actionItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "text"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["investigate", "workaround", "fix_posted", "upgrade", "ignore", "monitor", "block"]
        },
        "text": { "type": "string", "minLength": 1, "maxLength": 280 },
        "url": { "type": "string", "format": "uri" }
      }
    },

    "risk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["score", "reasons"],
      "properties": {
        "score": { "type": "number", "minimum": 0, "maximum": 1 },
        "reasons": {
          "type": "array",
          "maxItems": 10,
          "items": { "type": "string", "pattern": "^[a-z0-9_\\-]{2,64}$" }
        }
      }
    },

    "provenance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["fetched_at", "evidence_urls"],
      "properties": {
        "fetched_at": { "type": "string", "format": "date-time" },
        "evidence_urls": {
          "type": "array",
          "minItems": 1,
          "maxItems": 20,
          "items": { "type": "string", "format": "uri" }
        }
      }
    }
  }
}
